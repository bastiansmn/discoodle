(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-3e86551a"],{"1d8c":function(e,t,n){"use strict";n("94af")},"94af":function(e,t,n){},a3ab:function(e,t,n){"use strict";n.r(t);n("b0c0");var s=n("7a23"),o=Object(s["withScopeId"])("data-v-0f8a467a");Object(s["pushScopeId"])("data-v-0f8a467a");var a={class:"Channel"},i={class:"infos"},r={class:"name",style:{color:"#F4F4F4"}},c={class:"buttons"},d=Object(s["createVNode"])("img",{src:"../../../../assets/pin.png",alt:""},null,-1),u=Object(s["createVNode"])("img",{src:"../../../../assets/user.svg",alt:""},null,-1),l={class:"user-list"},g=Object(s["createVNode"])("span",{style:{"font-size":"18px",color:"#F4F4F4","font-weight":"600","margin-bottom":"30px"}},"Utilisateur(s) de la room :",-1),m={key:0,src:"../../../../assets/crown.svg",style:{height:"80%","margin-right":"10px"},alt:""},p={style:{"max-height":"70vh"}},h={style:{"margin-bottom":"10px"}},f={style:{"text-decoration":"underline"}},b=Object(s["createTextVNode"])(" : "),v=Object(s["createVNode"])("br",null,null,-1),O=Object(s["createVNode"])("br",null,null,-1),j={key:0,class:"conv-messages"},y={key:0,style:{"align-self":"center","font-size":"15px","font-weight":"500",color:"#F4F4F4"}},C={key:1,class:"conv-messages"},_=Object(s["createVNode"])("span",{style:{"align-self":"center","font-size":"17px","font-weight":"600",color:"#F4F4F4"}},"Vous n'avez pas la permission de lire les messages.",-1),N={class:"conv-input"},k={key:0},w={class:"right-side-input"},M=Object(s["createVNode"])("img",{src:"../../../../assets/happy.svg",alt:"Smiley",style:{width:"100%"}},null,-1),E={class:"submit-file",style:{cursor:"pointer"}},S=Object(s["createTextVNode"])(" + "),U={key:1,style:{"font-size":"17px","font-weight":"600"}};Object(s["popScopeId"])();var V=o((function(e,t,n,V,D,B){var R=Object(s["resolveComponent"])("w-drawer"),I=Object(s["resolveComponent"])("w-divider"),x=Object(s["resolveComponent"])("w-dialog"),A=Object(s["resolveComponent"])("Message"),F=Object(s["resolveComponent"])("EmojiPicker");return Object(s["openBlock"])(),Object(s["createBlock"])("div",a,[Object(s["createVNode"])("div",i,[Object(s["createVNode"])("div",null,[Object(s["createVNode"])("h2",r,Object(s["toDisplayString"])(D.room.room_name),1),Object(s["createVNode"])("div",c,[Object(s["createVNode"])("button",{style:[D.pinAdd?{animation:""}:{animation:"none"},{height:"100%"}],onClick:t[1]||(t[1]=function(e){D.showPinned=!D.showPinned})},[d],4),Object(s["createVNode"])("button",{style:{cursor:"pointer"},onClick:t[2]||(t[2]=function(e){D.showUserList=!0})},[u]),Object(s["createVNode"])(R,{modelValue:D.showUserList,"onUpdate:modelValue":t[3]||(t[3]=function(e){return D.showUserList=e}),right:"",width:"350px","bg-color":"grey-dark5",style:{"z-index":"550"}},{default:o((function(){return[Object(s["createVNode"])("div",l,[g,(Object(s["openBlock"])(!0),Object(s["createBlock"])(s["Fragment"],null,Object(s["renderList"])(e.getGroup.roles,(function(e){return Object(s["openBlock"])(),Object(s["createBlock"])("div",{class:"role",key:e.id},[Object(s["createVNode"])("span",null,Object(s["toDisplayString"])(e.name)+" - "+Object(s["toDisplayString"])(e.users.length),1),(Object(s["openBlock"])(!0),Object(s["createBlock"])(s["Fragment"],null,Object(s["renderList"])(e.users,(function(e){return Object(s["openBlock"])(),Object(s["createBlock"])("div",{key:e.id,class:"user"},[e.id===D.room.room_admin?(Object(s["openBlock"])(),Object(s["createBlock"])("img",m)):Object(s["createCommentVNode"])("",!0),Object(s["createTextVNode"])(" "+Object(s["toDisplayString"])(e.name)+" "+Object(s["toDisplayString"])(e.last_name.toUpperCase()),1)])})),128))])})),128))])]})),_:1},8,["modelValue"])]),Object(s["createVNode"])(x,{width:500,modelValue:D.showPinned,"onUpdate:modelValue":t[4]||(t[4]=function(e){return D.showPinned=e}),style:{"overflow-y":"auto"}},{default:o((function(){return[Object(s["createVNode"])("div",p,[Object(s["createVNode"])("h3",h,Object(s["toDisplayString"])(0===D.pinned.length?"Aucun message épinglé":"Liste des messages épinglés :"),1),Object(s["createVNode"])(I,{style:{"margin-bottom":"10px"}}),(Object(s["openBlock"])(!0),Object(s["createBlock"])(s["Fragment"],null,Object(s["renderList"])(D.pinned,(function(e){return Object(s["openBlock"])(),Object(s["createBlock"])("div",{key:e,class:"message-pinned"},[Object(s["createVNode"])("div",null,[Object(s["createVNode"])("strong",f,Object(s["toDisplayString"])(e.sender),1),b,v,Object(s["createTextVNode"])(" "+Object(s["toDisplayString"])(e.content)+" - "+Object(s["toDisplayString"])(new Date(e.message_date).toLocaleDateString())+" ",1),O]),D.rights.canModifyRoom?(Object(s["openBlock"])(),Object(s["createBlock"])("button",{key:0,class:"unpin-message",onClick:function(t){return B.unpinMessage(e.message_id)}}," X ",8,["onClick"])):Object(s["createCommentVNode"])("",!0)])})),128))])]})),_:1},8,["modelValue"])])]),D.rights.canReadMessage?(Object(s["openBlock"])(),Object(s["createBlock"])("div",j,[0===D.messages.length?(Object(s["openBlock"])(),Object(s["createBlock"])("span",y," Soyez le premier à envoyer un message à "+Object(s["toDisplayString"])(e.$route.query.name),1)):Object(s["createCommentVNode"])("",!0),(Object(s["openBlock"])(!0),Object(s["createBlock"])(s["Fragment"],null,Object(s["renderList"])(D.messages,(function(t){return Object(s["openBlock"])(),Object(s["createBlock"])(A,{key:t,content:t.content,sender:t.sender,belong_to_myself:t.sender===e.getUser.username,message_date:t.message_date,message_id:t.message_id,edited:t.edited,"can-pin":D.rights.canModifyRoom,"can-remove":D.rights.canModifyRoom,onPinnedMessage:B.pinnedMessage,onDeletedMessage:B.deletedMessage,onEditedMessage:B.editedMessage},null,8,["content","sender","belong_to_myself","message_date","message_id","edited","can-pin","can-remove","onPinnedMessage","onDeletedMessage","onEditedMessage"])})),128))])):(Object(s["openBlock"])(),Object(s["createBlock"])("div",C,[_])),Object(s["createVNode"])("div",N,[Object(s["createVNode"])("span",null,Object(s["toDisplayString"])(B.getWritersAsText()),1),D.rights.canSendMessage?(Object(s["openBlock"])(),Object(s["createBlock"])("div",k,[Object(s["createVNode"])("input",{type:"text",autocomplete:"off",placeholder:"Envoyer un message à ".concat(e.$route.query.name),onKeydown:t[5]||(t[5]=function(){return B.actionInput&&B.actionInput.apply(B,arguments)})},null,40,["placeholder"]),Object(s["createVNode"])("div",w,[D.showEmoji?(Object(s["openBlock"])(),Object(s["createBlock"])(F,{key:0,onSelectedEmoji:B.insertEmoji,onCloseEmoji:t[6]||(t[6]=function(e){return D.showEmoji=!1}),class:"emojiPicker"},null,8,["onSelectedEmoji"])):Object(s["createCommentVNode"])("",!0),Object(s["createVNode"])("button",{style:{height:"28px",width:"28px"},onClick:t[7]||(t[7]=function(e){return D.showEmoji=!D.showEmoji})},[M]),Object(s["createVNode"])("label",E,[S,Object(s["createVNode"])("input",{type:"file",ref:"uploadImage",onChange:t[8]||(t[8]=function(e){return B.uploadImage()}),style:{height:"0",width:"0"}},null,544)])])])):(Object(s["openBlock"])(),Object(s["createBlock"])("span",U," Vous n'avez pas la permission d'envoyer des messages. "))])])})),D=n("2909"),B=n("b85c"),R=n("1da1"),I=n("5530"),x=(n("96cf"),n("caad"),n("2532"),n("159b"),n("4de4"),n("ac1f"),n("5319"),n("99af"),n("a434"),n("a1f0"),n("bc3a")),A=n.n(x),F=n("5502"),P=n("0e54"),T=n.n(P),G=n("cc7d"),J=n.n(G),L=n("74d1"),z=n.n(L),q=n("4bdc"),W=n("d99d"),$=n("a289"),H=null,Z={name:"Channel",components:{EmojiPicker:$["a"],Message:W["a"]},computed:Object(I["a"])({},Object(F["c"])(["getCurrentConv","getUser","getFriends","getGroup"])),data:function(){return{room:{},writers:[],messages:[],pinned:[],showUserList:!1,pinAdd:!1,showPinned:!1,showEmoji:!1,rights:{canSendMessage:!1,canReadMessage:!1,canChangeGroup:!1,canModifyRoom:!1,canModifyNotes:!1,canStream:!1}}},methods:{connect:function(){var e=this,t=new J.a("/ws");H=z.a.over(t),H.debug=null,H.connect({},(function(){H.subscribe("/conversations/rooms/".concat(e.getCurrentConv),(function(t){e.onMessageReceived(t)}))}),this.errorCallBack)},disconnect:function(){null!==H&&H.disconnect()},errorCallBack:function(){var e=this;setTimeout((function(){e.connect()}),5e3)},onMessageReceived:function(e){var t=this,n=JSON.parse(e.body);n.sender!==this.getUser.username&&("MESSAGE"===n.type?this.messages.unshift({convUUID:n.convUUID,message_id:n.message_id,content:n.content,sender:n.sender,message_date:n.message_date,pinned:n.pinned,edited:!1}):"WRITING"===n.type?this.writers.includes(n.sender)||(this.writers.push(n.sender),setTimeout((function(){t.writers.pop(n.sender)}),5e3)):"PINNED"===n.type?this.messages.forEach((function(e){e.message_id!==n.message_id||t.pinned.includes(e)||t.pinned.push(e)})):"UNPINNED"===n.type?this.pinned=this.pinned.filter((function(e){return e.message_id!==n.message_id})):"DELETED"===n.type?(this.messages=this.messages.filter((function(e){return e.message_id!==n.message_id})),this.pinned=this.pinned.filter((function(e){return e.message_id!==n.message_id}))):"EDITED"===n.type?(this.messages.forEach((function(e){e.message_id===n.message_id&&(e.content=n.content,e.edited=!0)})),this.pinned.forEach((function(e){e.message_id===n.message_id&&(e.content=n.content,e.edited=!0)}))):"USERS_ADDED"===n.type?(n.users.forEach((function(e){t.containUsername(e)&&A.a.get("/api/users/findByUserName?username=".concat(e)).then((function(e){t.users.push(e.data)}))})),setTimeout((function(){t.getUserOfRoom()}),500)):"USER_REMOVED"===n.type?(this.users=this.users.filter((function(e){return e.id!==n.user_id})),setTimeout((function(){t.getUserOfRoom()}),500),n.user_id===this.getUser.id&&location.replace("/messages")):"CHANGE_ADMIN"===n.type&&(this.roomAdminID=n.user_id))},send:function(){var e=this,t=document.querySelector(".conv-input > div > input");t&&H&&A.a.post("/api/messages/sendMessage?room_uuid=".concat(this.getCurrentConv),{conv_uuid:this.getCurrentConv,content:t.value,sender:this.getUser.username,message_date:Date.now()}).then((function(n){e.messages.unshift(n.data),H.send("/conversations/rooms/".concat(e.getCurrentConv),{},JSON.stringify(n.data)),t.value=""}))},writing:function(){this.writers.includes(this.getUser.username)||H.send("/conversations/rooms/".concat(this.getCurrentConv),{},JSON.stringify({sender:this.getUser.username,type:"WRITING"}))},promoteAdmin:function(e){A.a.put("/api/rooms/changeAdmin?room_id=".concat(this.getCurrentConv,"&admin=").concat(e)),H.send("/conversations/rooms/".concat(this.getCurrentConv),{},JSON.stringify({user_id:e,type:"CHANGE_ADMIN"}))},unpinMessage:function(e){var t=this;A.a.put("/api/messages/unpinMessage?message_id=".concat(e)).then((function(){var n=0;t.pinned.forEach((function(s){s.message_id===e&&t.pinned.splice(n,1),n++})),H.send("/conversations/rooms/".concat(t.getCurrentConv),{},JSON.stringify({message_id:e,type:"UNPINNED"}))}))},pinnedMessage:function(e){var t=this;this.messages.forEach((function(n){n.message_id!==e||t.pinned.includes(n)||(H.send("/conversations/rooms/".concat(t.getCurrentConv),{},JSON.stringify({message_id:e,type:"PINNED"})),t.pinned.push(n))}))},deletedMessage:function(e){H.send("/conversations/rooms/".concat(this.getCurrentConv),{},JSON.stringify({message_id:e,type:"DELETED"}))},editedMessage:function(e,t){H.send("/conversations/rooms/".concat(this.getCurrentConv),{},JSON.stringify({message_id:e,content:t,type:"EDITED"}))},addUsers:function(e){var t=this;return Object(R["a"])(regeneratorRuntime.mark((function n(){var s,o,a;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:s=Object(B["a"])(e),n.prev=1,s.s();case 3:if((o=s.n()).done){n.next=10;break}if(a=o.value,!t.containUsername(a)){n.next=8;break}return n.next=8,A.a.get("/api/users/findByUserName?username=".concat(a)).then((function(e){A.a.post("/api/rooms/addNewMember?room_id=".concat(t.getCurrentConv,"&user_id=").concat(e.data.id))}));case 8:n.next=3;break;case 10:n.next=15;break;case 12:n.prev=12,n.t0=n["catch"](1),s.e(n.t0);case 15:return n.prev=15,s.f(),n.finish(15);case 18:H.send("/conversations/rooms/".concat(t.getCurrentConv),{},JSON.stringify({users:e,type:"USERS_ADDED"}));case 19:case"end":return n.stop()}}),n,null,[[1,12,15,18]])})))()},removerUser:function(e){A.a.delete("/api/rooms/removeMember?room_id=".concat(this.getCurrentConv,"&user_id=").concat(e)),H.send("/conversations/rooms/".concat(this.getCurrentConv),{},JSON.stringify({user_id:e,type:"USER_REMOVED"}))},uploadImage:function(){var e=this,t=this.$refs.uploadImage.files[0],n=new FormData;n.append("file",t),A()({url:"/api/uploadfile/uploadImageInChat?room_id=".concat(this.getCurrentConv),method:"POST",data:n,headers:{Accept:"application/json","Content-type":"multipart/form-data"}}).then((function(t){"L'extension n'est pas un fichier jpg ou png, il ne peut donc pas être upload"!==t.data&&"Erreur lors du téléchargement de l'image !"!==t.data&&A.a.post("/api/messages/sendMessage?room_uuid=".concat(e.getCurrentConv),{conv_uuid:e.getCurrentConv,content:"![".concat("Image de "+e.getUser.username,"](").concat(t.data,")"),sender:e.getUser.username,message_date:Date.now()}).then((function(t){e.messages.unshift(t.data),H.send("/conversations/rooms/".concat(e.getCurrentConv),{},JSON.stringify(t.data))}))}))},insertEmoji:function(e){document.querySelector(".conv-input > div > input").value+=e},filterEmoji:function(e){var t=":[a-zA-Z0-9]+(?:_[a-zA-Z0-9]+)*:",n=Object(D["a"])(e.matchAll(t));return n&&n.length>0&&n.forEach((function(t){q["a"][t[0].replaceAll(":","")]&&(e=e.replace(t[0],q["a"][t[0].replaceAll(":","")]))})),e},filterMarkdown:function(e){return T()(e)},filterPing:function(e){return e.includes("@".concat(this.getUser.username))?(this.mention=!0,e.replaceAll("@".concat(this.getUser.username),"@".concat(this.getUser.name))):e},displayMessage:function(e,t,n,s){return s&&(e=this.filterPing(e)),n&&(e=this.filterEmoji(e)),t&&(e=this.filterMarkdown(e)),e},getUserOfRoom:function(){var e=this;A.a.get("/api/rooms/findUserOfRoom?room_id=".concat(this.getCurrentConv)).then((function(t){e.room.users=t.data}))},getMessagesFromJSON:function(){var e=this;A.a.get("/api/messages?room_uuid=".concat(this.getCurrentConv)).then((function(t){e.messages=t.data.sort((function(e,t){return t.message_date-e.message_date})),e.pinned=e.messages.filter((function(e){return!0===e.pinned}))}))},actionInput:function(e){if(13===e.keyCode&&""!==document.querySelector(".conv-input > div > input").value)this.send(),this.writers.pop(this.getUser.username);else if(13!==e.keyCode){this.writing();var t=document.querySelector(".conv-input > div > input");t.value=this.displayMessage(t.value,!1,!0,!1)}},getWritersAsText:function(){var e=this;if(0===this.writers.length)return"";if(1===this.writers.length)return"".concat(this.writers[0]," est en train d'écrire...");if(this.writers.length>4)return"Plusieurs personnes sont en train d'écrire";var t="";return this.writers.forEach((function(n){t+=n===e.writers[e.writers.length-1]?"et ".concat(n):"".concat(n).concat(n===e.writers[e.writers.length-2]?"":","," ")})),"".concat(t," sont en train d'écrire...")},containUsername:function(e){var t=!1;return this.getFriends.forEach((function(n){n.username===e&&(t=!0)})),t}},mounted:function(){var e=this;A.a.get("/api/rooms/findRoomByID?room_uuid=".concat(this.getCurrentConv)).then((function(t){e.room=t.data,e.getMessagesFromJSON(),e.connect()})),A.a.get("/api/groups/getRoleByGroupAndUser?user_id=".concat(this.getUser.id,"&group_id=").concat(this.getGroup.groups_id)).then((function(t){var n=!1;if(t.data.forEach((function(e){"*"===e.rights&&(n=!0)})),n)e.rights={canSendMessage:!0,canReadMessage:!0,canChangeGroup:!0,canModifyRoom:!0,canModifyNotes:!0,canStream:!0};else{t.data.sort((function(e,t){return e.rights.length-t.rights.length}));var s=t.data[t.data.length-1].rights;e.rights={canSendMessage:s.includes("s"),canReadMessage:s.includes("r"),canChangeGroup:s.includes("p"),canModifyRoom:s.includes("c"),canModifyNotes:s.includes("n"),canStream:s.includes("l")}}}))},beforeRouteUpdate:function(){var e=this;this.disconnect(),A.a.get("/api/rooms/findRoomByID?room_uuid=".concat(this.getCurrentConv)).then((function(t){e.room=t.data,e.getMessagesFromJSON()})),this.connect(),A.a.get("/api/groups/getRoleByGroupAndUser?user_id=".concat(this.getUser.id,"&group_id=").concat(this.getGroup.groups_id)).then((function(t){var n=!1;if(t.data.forEach((function(e){"*"===e.rights&&(n=!0)})),n)e.rights={canSendMessage:!0,canReadMessage:!0,canChangeGroup:!0,canModifyRoom:!0,canModifyNotes:!0,canStream:!0};else{t.data.sort((function(e,t){return e.rights.length-t.rights.length}));var s=t.data[t.data.length-1].rights;e.rights={canSendMessage:s.includes("s"),canReadMessage:s.includes("r"),canChangeGroup:s.includes("p"),canModifyRoom:s.includes("c"),canModifyNotes:s.includes("n"),canStream:s.includes("l")}}}))},unmounted:function(){this.disconnect()}};n("1d8c");Z.render=V,Z.__scopeId="data-v-0f8a467a";t["default"]=Z}}]);
//# sourceMappingURL=chunk-3e86551a.d817a805.js.map